{"version":3,"file":"sharepoint-BSZBMNpd.js","sources":["../../src/lib/normalize.ts","../../src/lib/sharepoint.ts"],"sourcesContent":["import type { Modality, TrainingRecord } from \"./schema\";\r\n\r\nfunction cleanText(s: string): string {\r\n  return s.replace(/\\u00a0/g, \" \").trim().replace(/\\s+/g, \" \");\r\n}\r\n\r\nfunction splitCsvList(s: string): string[] {\r\n  const v = cleanText(s);\r\n  if (!v) return [];\r\n  return v\r\n    .split(\",\")\r\n    .map((p) => p.trim())\r\n    .filter(Boolean);\r\n}\r\n\r\nexport function normalizeModality(raw: string): Modality {\r\n  const v = cleanText(raw).toLowerCase();\r\n  if (!v) return \"unknown\";\r\n  if (v === \"online\" || v === \"e-learning\" || v === \"elearning\") return \"online\";\r\n  if (v === \"in-person\" || v === \"in person\" || v === \"inperson\") return \"in_person\";\r\n  if (v === \"blended\") return \"blended\";\r\n  if (v === \"training toolkits and packages\" || v === \"toolkit\" || v === \"toolkits\")\r\n    return \"toolkit\";\r\n  return \"unknown\";\r\n}\r\n\r\nexport async function stableIdFromText(text: string): Promise<string> {\r\n  // Stable deterministic ID derived from the training title+link.\r\n  const data = new TextEncoder().encode(text);\r\n  const digest = await crypto.subtle.digest(\"SHA-256\", data);\r\n  const hex = [...new Uint8Array(digest)].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n  return hex.slice(0, 24);\r\n}\r\n\r\nexport async function normalizeRow(\r\n  row: Record<string, string | undefined>,\r\n  sourceRow?: number\r\n): Promise<TrainingRecord> {\r\n  const learningName = cleanText(row[\"Learning Name\"] ?? \"\");\r\n  const description = cleanText(row[\"Description\"] ?? \"\");\r\n  const technicalArea = cleanText(row[\"Technical area\"] ?? \"\");\r\n  const focusArea = cleanText(row[\"Focus area\"] ?? \"\");\r\n  const intendedAudience = cleanText(row[\"Intended audience\"] ?? \"\");\r\n  const owner = cleanText(row[\"Owner\"] ?? \"\");\r\n  const developer = cleanText(row[\"Developer\"] ?? \"\");\r\n  const contactDetails = cleanText(row[\"Contact details\"] ?? \"\");\r\n  const languages = splitCsvList(row[\"Language\"] ?? \"\");\r\n  const modalityRaw = row[\"Modality\"] ?? \"\";\r\n  const modality = normalizeModality(modalityRaw);\r\n  const platform = cleanText(row[\"Platform\"] ?? \"\");\r\n  const link = cleanText(row[\"Link\"] ?? \"\");\r\n  const comment = cleanText(row[\"Comment\"] ?? \"\");\r\n  const signoffStatus = cleanText(row[\"Sign-off status\"] ?? \"\");\r\n\r\n  const normalizedLink = cleanText(link.replace(/&amp;/g, \"&\"));\r\n\r\n  const searchText = [\r\n    learningName,\r\n    description,\r\n    technicalArea,\r\n    focusArea,\r\n    intendedAudience,\r\n    owner,\r\n    developer,\r\n    contactDetails,\r\n    languages.join(\", \"),\r\n    platform,\r\n    normalizedLink\r\n  ]\r\n    .join(\" | \")\r\n    .toLowerCase();\r\n\r\n  const id = await stableIdFromText(`${learningName}||${normalizedLink}`);\r\n\r\n  return {\r\n    id,\r\n    sourceRow,\r\n    learningName,\r\n    description,\r\n    technicalArea,\r\n    focusArea,\r\n    intendedAudience,\r\n    owner,\r\n    developer,\r\n    contactDetails,\r\n    languages,\r\n    modalityRaw: cleanText(modalityRaw),\r\n    modality,\r\n    platform,\r\n    link,\r\n    comment,\r\n    signoffStatus,\r\n    normalizedLink,\r\n    searchText\r\n  };\r\n}\r\n\r\n","import type { TrainingRecord } from \"./schema\";\r\nimport { normalizeRow } from \"./normalize\";\r\n\r\nexport interface SharePointListConfig {\r\n  /**\r\n   * Example: \"/sites/EuroWCPHE\" or \"\" for root site.\r\n   * When hosted inside SharePoint, this should match the site that contains the COPY list.\r\n   */\r\n  siteRelativeUrl: string;\r\n  listTitle: string;\r\n}\r\n\r\nconst FIELDS = [\r\n  \"Learning_x0020_Name\",\r\n  \"field_2\",\r\n  \"Description\",\r\n  \"field_3\",\r\n  \"Technical_x0020_area\",\r\n  \"field_4\",\r\n  \"Focus_x0020_area\",\r\n  \"field_8\",\r\n  \"Intended_x0020_audience\",\r\n  \"field_11\",\r\n  \"Owner\",\r\n  \"field_5\",\r\n  \"Developer\",\r\n  \"field_7\",\r\n  \"Contact_x0020_details\",\r\n  \"field_6\",\r\n  \"Language\",\r\n  \"field_9\",\r\n  \"Modality\",\r\n  \"field_12\",\r\n  \"Platform\",\r\n  \"field_10\",\r\n  \"Link\",\r\n  \"field_14\",\r\n  \"Comment\",\r\n  \"field_17\",\r\n  \"_Flow_SignoffStatus\"\r\n];\r\n\r\nfunction spUrl(config: SharePointListConfig, apiPath: string): string {\r\n  const base = config.siteRelativeUrl ? config.siteRelativeUrl.replace(/\\/+$/, \"\") : \"\";\r\n  return `${base}${apiPath}`;\r\n}\r\n\r\nfunction mapItemToCsvHeaderShape(item: Record<string, unknown>): Record<string, string> {\r\n  const get = (key: string): string => {\r\n    const v = item[key];\r\n    if (v === null || v === undefined) return \"\";\r\n    if (typeof v === \"string\") return v;\r\n    return String(v);\r\n  };\r\n\r\n  // The CSV export used friendly display names; the list uses internal names.\r\n  // We map to the CSV header keys so the rest of the pipeline stays consistent.\r\n  return {\r\n    \"Learning Name\": get(\"field_2\"),\r\n    Description: get(\"field_3\"),\r\n    \"Technical area\": get(\"field_4\"),\r\n    \"Focus area\": get(\"field_8\"),\r\n    \"Intended audience\": get(\"field_11\"),\r\n    Owner: get(\"field_5\"),\r\n    Developer: get(\"field_7\"),\r\n    \"Contact details\": get(\"field_6\"),\r\n    Language: get(\"field_9\"),\r\n    Modality: get(\"field_12\"),\r\n    Platform: get(\"field_10\"),\r\n    Link: get(\"field_14\"),\r\n    Comment: get(\"field_17\"),\r\n    \"Sign-off status\": get(\"_Flow_SignoffStatus\")\r\n  };\r\n}\r\n\r\ntype SPItemsResponse = {\r\n  value?: Array<Record<string, unknown>>;\r\n  \"odata.nextLink\"?: string;\r\n  \"@odata.nextLink\"?: string;\r\n};\r\n\r\nasync function spFetchJson(url: string): Promise<SPItemsResponse> {\r\n  const r = await fetch(url, {\r\n    headers: {\r\n      Accept: \"application/json;odata=nometadata\"\r\n    },\r\n    credentials: \"same-origin\"\r\n  });\r\n  if (!r.ok) {\r\n    const text = await r.text();\r\n    throw new Error(`SharePoint REST error ${r.status} ${r.statusText}: ${text.slice(0, 500)}`);\r\n  }\r\n  return (await r.json()) as SPItemsResponse;\r\n}\r\n\r\nexport async function fetchAllListItems(config: SharePointListConfig): Promise<TrainingRecord[]> {\r\n  // Use REST; supports page-embedded static UI with SSO cookies.\r\n  const select = [\r\n    \"Id\",\r\n    \"field_2\",\r\n    \"field_3\",\r\n    \"field_4\",\r\n    \"field_5\",\r\n    \"field_6\",\r\n    \"field_7\",\r\n    \"field_8\",\r\n    \"field_9\",\r\n    \"field_10\",\r\n    \"field_11\",\r\n    \"field_12\",\r\n    \"field_14\",\r\n    \"field_17\",\r\n    \"_Flow_SignoffStatus\"\r\n  ].join(\",\");\r\n\r\n  let url = spUrl(\r\n    config,\r\n    `/_api/web/lists/getbytitle('${encodeURIComponent(config.listTitle)}')/items?$select=${select}&$top=5000`\r\n  );\r\n\r\n  const out: TrainingRecord[] = [];\r\n  while (url) {\r\n    const data = await spFetchJson(url);\r\n    const items = data.value ?? [];\r\n    for (const item of items) {\r\n      const shaped = mapItemToCsvHeaderShape(item);\r\n      const rec = await normalizeRow(shaped);\r\n      out.push(rec);\r\n    }\r\n    url = (data[\"@odata.nextLink\"] || data[\"odata.nextLink\"] || \"\") as string;\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\n"],"names":["cleanText","s","splitCsvList","v","p","normalizeModality","raw","stableIdFromText","text","data","digest","b","normalizeRow","row","sourceRow","learningName","description","technicalArea","focusArea","intendedAudience","owner","developer","contactDetails","languages","modalityRaw","modality","platform","link","comment","signoffStatus","normalizedLink","searchText","spUrl","config","apiPath","mapItemToCsvHeaderShape","item","get","key","spFetchJson","url","r","fetchAllListItems","select","out","items","shaped","rec"],"mappings":"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"}