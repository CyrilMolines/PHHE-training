{"version":3,"file":"chatModel-Dp5WF3E6.js","sources":["../../src/lib/chatModel.ts"],"sourcesContent":["import { env, pipeline } from \"@huggingface/transformers\";\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nlet _chatPipe: any = null;\n\nexport interface ChatModelConfig {\n  modelsBasePath: string;\n  allowRemoteModels: boolean;\n}\n\n// SmolLM-135M-Instruct for lightweight conversational AI\nconst CHAT_MODEL_ID = \"HuggingFaceTB/SmolLM-135M-Instruct\";\n\nfunction normalizeBasePath(p: string): string {\n  const v = p.trim();\n  if (!v) return \"./models\";\n  return v.replace(/\\/+$/, \"\");\n}\n\nexport async function loadChatModel(cfg: ChatModelConfig): Promise<typeof _chatPipe> {\n  if (_chatPipe) return _chatPipe;\n\n  // When allowRemoteModels is true, disable local models to avoid 404 errors\n  env.allowLocalModels = !cfg.allowRemoteModels;\n  env.allowRemoteModels = cfg.allowRemoteModels;\n  \n  if (!cfg.allowRemoteModels) {\n    env.localModelPath = normalizeBasePath(cfg.modelsBasePath);\n  }\n\n  console.log(`[ChatModel] Loading SmolLM-135M-Instruct...`);\n  const startTime = performance.now();\n\n  _chatPipe = await pipeline(\"text-generation\", CHAT_MODEL_ID, {\n    dtype: \"fp32\",\n    progress_callback: (progress: { status: string; progress?: number }) => {\n      if (progress.progress !== undefined) {\n        console.log(`[ChatModel] ${progress.status}: ${Math.round(progress.progress)}%`);\n      }\n    }\n  });\n\n  console.log(`[ChatModel] Model loaded in ${Math.round(performance.now() - startTime)}ms`);\n  return _chatPipe;\n}\n\nexport interface ExtractedIntent {\n  topic: string;\n  language?: string;\n  modality?: \"online\" | \"in_person\" | \"blended\";\n  platform?: string;\n  audience?: string;\n  rawQuery: string;\n}\n\nexport interface TrainingSummary {\n  name: string;\n  description: string;\n  technicalArea: string;\n  focusArea: string;\n  platform: string;\n  languages: string[];\n  modality: string;\n}\n\n/**\n * Use SmolLM to extract structured intent from user query\n */\nexport async function extractIntent(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  pipe: any,\n  userQuery: string\n): Promise<ExtractedIntent> {\n  const prompt = `<|im_start|>system\nYou extract training search parameters from user queries.\nIMPORTANT: The \"topic\" field should contain ONLY the subject matter (like \"emergency response\", \"cholera\", \"infection prevention\"), NOT filters like language, modality, or platform.\nExtract: topic (subject only), language, modality (online/in-person/blended), platform, audience.\nRespond with JSON only.\n<|im_end|>\n<|im_start|>user\nQuery: \"${userQuery}\"\n<|im_end|>\n<|im_start|>assistant\n{`;\n\n  try {\n    const result = await pipe(prompt, {\n      max_new_tokens: 150,\n      temperature: 0.1,\n      do_sample: false,\n      return_full_text: false\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const text = \"{\" + ((result as any)[0]?.generated_text || \"\").split(\"}\")[0] + \"}\";\n    \n    try {\n      const parsed = JSON.parse(text);\n      return {\n        topic: parsed.topic || userQuery,\n        language: parsed.language,\n        modality: parsed.modality,\n        platform: parsed.platform,\n        audience: parsed.audience,\n        rawQuery: userQuery\n      };\n    } catch {\n      // If JSON parsing fails, fall back to basic extraction\n      return fallbackExtractIntent(userQuery);\n    }\n  } catch (e) {\n    console.warn(\"[ChatModel] Intent extraction failed, using fallback:\", e);\n    return fallbackExtractIntent(userQuery);\n  }\n}\n\n/**\n * Fallback regex-based intent extraction\n * Extracts topic (the subject matter) separately from filters (language, modality, platform)\n */\nfunction fallbackExtractIntent(query: string): ExtractedIntent {\n  const t = query.toLowerCase();\n  let topic = query;\n  \n  const intent: ExtractedIntent = {\n    topic: query,\n    rawQuery: query\n  };\n\n  // Extract and remove language from topic\n  const languages = [\"english\", \"french\", \"spanish\", \"russian\", \"arabic\", \"portuguese\", \"chinese\", \"ukrainian\", \"polish\"];\n  for (const lang of languages) {\n    const langPattern = new RegExp(`\\\\b(in\\\\s+)?${lang}\\\\b`, \"gi\");\n    if (langPattern.test(t)) {\n      intent.language = lang.charAt(0).toUpperCase() + lang.slice(1);\n      topic = topic.replace(langPattern, \"\");\n      break;\n    }\n  }\n\n  // Extract and remove modality from topic\n  if (/\\bonline\\b|e-learning|elearning/i.test(t)) {\n    intent.modality = \"online\";\n    topic = topic.replace(/\\bonline\\b|e-learning|elearning/gi, \"\");\n  } else if (/\\bin[- ]person\\b|face[- ]to[- ]face/i.test(t)) {\n    intent.modality = \"in_person\";\n    topic = topic.replace(/\\bin[- ]person\\b|face[- ]to[- ]face/gi, \"\");\n  } else if (/\\bblended\\b|hybrid/i.test(t)) {\n    intent.modality = \"blended\";\n    topic = topic.replace(/\\bblended\\b|hybrid/gi, \"\");\n  }\n\n  // Extract and remove platform from topic\n  if (/openwho/i.test(t)) {\n    intent.platform = \"OpenWHO\";\n    topic = topic.replace(/openwho/gi, \"\");\n  } else if (/who academy/i.test(t)) {\n    intent.platform = \"WHO Academy\";\n    topic = topic.replace(/who academy/gi, \"\");\n  } else if (/hslp/i.test(t)) {\n    intent.platform = \"HSLP\";\n    topic = topic.replace(/hslp/gi, \"\");\n  } else if (/goarn/i.test(t)) {\n    intent.platform = \"GOARN\";\n    topic = topic.replace(/goarn/gi, \"\");\n  }\n\n  // Extract audience (don't remove from topic as it might be relevant)\n  if (/member state|ministry|moh\\b/i.test(t)) intent.audience = \"Member\";\n  else if (/who staff/i.test(t)) intent.audience = \"WHO\";\n\n  // Clean up topic: remove filler words and extra whitespace\n  topic = topic\n    .replace(/\\b(i need|i want|i'm looking for|looking for|find me|show me|a training|training|about|on|for)\\b/gi, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n  \n  // If topic is empty after cleaning, use a generic search term\n  intent.topic = topic || \"health emergency\";\n\n  return intent;\n}\n\n/**\n * Generate a natural language response summarizing search results\n */\nexport async function generateResponse(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  pipe: any,\n  intent: ExtractedIntent,\n  trainings: TrainingSummary[],\n  totalMatches: number\n): Promise<string> {\n  if (trainings.length === 0) {\n    return generateNoResultsResponse(intent);\n  }\n\n  const topTrainings = trainings.slice(0, 3).map((t, i) => \n    `${i + 1}. \"${t.name}\" (${t.platform || \"Various\"}, ${t.languages.join(\", \") || \"Multiple languages\"})`\n  ).join(\"\\n\");\n\n  const filtersUsed = [];\n  if (intent.language) filtersUsed.push(`language: ${intent.language}`);\n  if (intent.modality) filtersUsed.push(`modality: ${intent.modality}`);\n  if (intent.platform) filtersUsed.push(`platform: ${intent.platform}`);\n\n  const prompt = `<|im_start|>system\nYou are a helpful training advisor. Summarize search results in 2-3 friendly sentences.\n<|im_end|>\n<|im_start|>user\nUser searched for: \"${intent.topic}\"\n${filtersUsed.length ? `Filters: ${filtersUsed.join(\", \")}` : \"\"}\nFound ${totalMatches} matching trainings. Top results:\n${topTrainings}\n\nWrite a brief, helpful response:\n<|im_end|>\n<|im_start|>assistant\n`;\n\n  try {\n    const result = await pipe(prompt, {\n      max_new_tokens: 100,\n      temperature: 0.7,\n      do_sample: true,\n      return_full_text: false\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const text = ((result as any)[0]?.generated_text || \"\").trim();\n    \n    if (text && text.length > 20) {\n      return text;\n    }\n  } catch (e) {\n    console.warn(\"[ChatModel] Response generation failed:\", e);\n  }\n\n  // Fallback to template response\n  return generateTemplateResponse(intent, trainings, totalMatches);\n}\n\nfunction generateNoResultsResponse(intent: ExtractedIntent): string {\n  const filters = [];\n  if (intent.language) filters.push(`in ${intent.language}`);\n  if (intent.modality) filters.push(intent.modality.replace(\"_\", \"-\"));\n  if (intent.platform) filters.push(`on ${intent.platform}`);\n  \n  const filterStr = filters.length ? ` ${filters.join(\", \")}` : \"\";\n  return `I couldn't find any trainings matching \"${intent.topic}\"${filterStr}. Try broadening your search or removing some filters.`;\n}\n\nfunction generateTemplateResponse(\n  intent: ExtractedIntent,\n  trainings: TrainingSummary[],\n  totalMatches: number\n): string {\n  const filters = [];\n  if (intent.language) filters.push(`in ${intent.language}`);\n  if (intent.modality) filters.push(intent.modality.replace(\"_\", \"-\"));\n  if (intent.platform) filters.push(`on ${intent.platform}`);\n  \n  const filterStr = filters.length ? ` (${filters.join(\", \")})` : \"\";\n  const topName = trainings[0]?.name || \"relevant training\";\n  \n  return `I found ${totalMatches} training(s) related to \"${intent.topic}\"${filterStr}. The top match is \"${topName}\". ${totalMatches > 1 ? \"Check out the results below for more options.\" : \"\"}`;\n}\n\n/**\n * Check if chat model is loaded\n */\nexport function isChatModelLoaded(): boolean {\n  return _chatPipe !== null;\n}\n\n/**\n * Get chat model info\n */\nexport function getChatModelInfo(): { name: string; size: string; capability: string } {\n  return {\n    name: \"SmolLM-135M-Instruct\",\n    size: \"~270MB\",\n    capability: \"Conversational AI, intent extraction, response generation\"\n  };\n}\n"],"names":["_chatPipe","CHAT_MODEL_ID","normalizeBasePath","p","v","loadChatModel","cfg","env","startTime","pipeline","progress","extractIntent","pipe","userQuery","prompt","text","parsed","fallbackExtractIntent","e","query","t","topic","intent","languages","lang","langPattern","generateResponse","trainings","totalMatches","generateNoResultsResponse","topTrainings","filtersUsed","generateTemplateResponse","filters","filterStr","topName"],"mappings":"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"}