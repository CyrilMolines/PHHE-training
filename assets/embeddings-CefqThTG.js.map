{"version":3,"file":"embeddings-CefqThTG.js","sources":["../../src/lib/embeddings.ts"],"sourcesContent":["import { env, pipeline } from \"@huggingface/transformers\";\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nlet _pipe: any = null;\r\nlet _currentModel: string | null = null;\r\n\r\nexport interface EmbeddingsConfig {\r\n  modelsBasePath: string;\r\n  allowRemoteModels: boolean;\r\n  embeddingModel: \"minilm\" | \"bge-small\" | \"gte-small\";\r\n}\r\n\r\n// Model configurations\r\nconst MODEL_MAP = {\r\n  \"minilm\": \"Xenova/all-MiniLM-L6-v2\",\r\n  \"bge-small\": \"Xenova/bge-small-en-v1.5\",\r\n  \"gte-small\": \"Xenova/gte-small\"\r\n} as const;\r\n\r\nfunction normalizeBasePath(p: string): string {\r\n  const v = p.trim();\r\n  if (!v) return \"./models\";\r\n  return v.replace(/\\/+$/, \"\");\r\n}\r\n\r\nexport async function loadEmbeddingsPipeline(cfg: EmbeddingsConfig): Promise<typeof _pipe> {\r\n  const modelId = MODEL_MAP[cfg.embeddingModel] || MODEL_MAP[\"bge-small\"];\r\n  \r\n  // Return cached pipeline if same model\r\n  if (_pipe && _currentModel === modelId) return _pipe;\r\n  \r\n  // Clear cache if switching models\r\n  if (_pipe && _currentModel !== modelId) {\r\n    _pipe = null;\r\n  }\r\n\r\n  // When allowRemoteModels is true, disable local models to avoid 404 errors\r\n  env.allowLocalModels = !cfg.allowRemoteModels;\r\n  env.allowRemoteModels = cfg.allowRemoteModels;\r\n  \r\n  if (!cfg.allowRemoteModels) {\r\n    env.localModelPath = normalizeBasePath(cfg.modelsBasePath);\r\n  }\r\n\r\n  console.log(`[Embeddings] Loading model: ${modelId}`);\r\n  const startTime = performance.now();\r\n  \r\n  _pipe = await pipeline(\"feature-extraction\", modelId, {\r\n    dtype: \"fp32\",\r\n    progress_callback: (progress: { status: string; progress?: number }) => {\r\n      if (progress.progress !== undefined) {\r\n        console.log(`[Embeddings] ${progress.status}: ${Math.round(progress.progress)}%`);\r\n      }\r\n    }\r\n  });\r\n  \r\n  _currentModel = modelId;\r\n  console.log(`[Embeddings] Model loaded in ${Math.round(performance.now() - startTime)}ms`);\r\n  \r\n  return _pipe;\r\n}\r\n\r\nexport async function embedText(\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  pipe: any,\r\n  text: string\r\n): Promise<Float32Array> {\r\n  // Mean pooling over token embeddings.\r\n  const out = await pipe(text, { pooling: \"mean\", normalize: true });\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const data = (out as any).data as Float32Array;\r\n  return data;\r\n}\r\n\r\nexport function cosineSimilarity(a: Float32Array, b: Float32Array): number {\r\n  if (a.length !== b.length) throw new Error(`cosine dims mismatch: ${a.length} vs ${b.length}`);\r\n  let dot = 0;\r\n  for (let i = 0; i < a.length; i++) dot += a[i] * b[i];\r\n  return dot;\r\n}\r\n\r\nexport function getModelInfo(model: EmbeddingsConfig[\"embeddingModel\"]): { name: string; size: string; quality: string } {\r\n  const info = {\r\n    \"minilm\": { name: \"MiniLM-L6-v2\", size: \"~23MB\", quality: \"Good\" },\r\n    \"bge-small\": { name: \"BGE-Small-EN\", size: \"~130MB\", quality: \"Excellent\" },\r\n    \"gte-small\": { name: \"GTE-Small\", size: \"~67MB\", quality: \"Very Good\" }\r\n  };\r\n  return info[model] || info[\"bge-small\"];\r\n}\r\n"],"names":["_pipe","_currentModel","MODEL_MAP","normalizeBasePath","p","v","loadEmbeddingsPipeline","cfg","modelId","env","startTime","pipeline","progress","embedText","pipe","text","cosineSimilarity","a","b","dot","i"],"mappings":"0DAGA,IAAIA,EAAa,KACbC,EAA+B,KASnC,MAAMC,EAAY,CAChB,OAAU,0BACV,YAAa,2BACb,YAAa,kBACf,EAEA,SAASC,EAAkBC,EAAmB,CAC5C,MAAMC,EAAID,EAAE,KAAA,EACZ,OAAKC,EACEA,EAAE,QAAQ,OAAQ,EAAE,EADZ,UAEjB,CAEA,eAAsBC,EAAuBC,EAA8C,CACzF,MAAMC,EAAUN,EAAUK,EAAI,cAAc,GAAKL,EAAU,WAAW,EAGtE,GAAIF,GAASC,IAAkBO,EAAS,OAAOR,EAG3CA,GAASC,IAAkBO,IAC7BR,EAAQ,MAIVS,EAAI,iBAAmB,CAACF,EAAI,kBAC5BE,EAAI,kBAAoBF,EAAI,kBAEvBA,EAAI,oBACPE,EAAI,eAAiBN,EAAkBI,EAAI,cAAc,GAG3D,QAAQ,IAAI,+BAA+BC,CAAO,EAAE,EACpD,MAAME,EAAY,YAAY,IAAA,EAE9B,OAAAV,EAAQ,MAAMW,EAAS,qBAAsBH,EAAS,CACpD,MAAO,OACP,kBAAoBI,GAAoD,CAClEA,EAAS,WAAa,QACxB,QAAQ,IAAI,gBAAgBA,EAAS,MAAM,KAAK,KAAK,MAAMA,EAAS,QAAQ,CAAC,GAAG,CAEpF,CAAA,CACD,EAEDX,EAAgBO,EAChB,QAAQ,IAAI,gCAAgC,KAAK,MAAM,YAAY,IAAA,EAAQE,CAAS,CAAC,IAAI,EAElFV,CACT,CAEA,eAAsBa,EAEpBC,EACAC,EACuB,CAKvB,OAHY,MAAMD,EAAKC,EAAM,CAAE,QAAS,OAAQ,UAAW,GAAM,GAEvC,IAE5B,CAEO,SAASC,EAAiBC,EAAiBC,EAAyB,CACzE,GAAID,EAAE,SAAWC,EAAE,OAAQ,MAAM,IAAI,MAAM,yBAAyBD,EAAE,MAAM,OAAOC,EAAE,MAAM,EAAE,EAC7F,IAAIC,EAAM,EACV,QAASC,EAAI,EAAGA,EAAIH,EAAE,OAAQG,IAAKD,GAAOF,EAAEG,CAAC,EAAIF,EAAEE,CAAC,EACpD,OAAOD,CACT"}